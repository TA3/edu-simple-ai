<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./browser.js"></script>
    <script src="./dataset.js"></script>
</head>
<body>
    <div class="container">
        <h2>Student Overall</h2>
        <div class="inputs" >
            <input id="PR" type="number" placeholder="PR" class="score" max="100" min="0">
            <input id="PW" type="number" placeholder="PW" class="score" max="100" min="0">
            <input id="PS" type="number" placeholder="PS" class="score" max="100" min="0">
            <input id="PL" type="number" placeholder="PL" class="score" max="100" min="0">
            <input id="Att" type="number" placeholder="Att" class="score" max="100" min="0">
        </div>
        <button onclick="estimate()" class="estimate">Estimate</button>
        <div class="result">Expected: <span id="result">--</span>%</div>
        <div class="log">
                <span class="title">Log data</span>
                <span id="log">[!] Preparing neural network...</span>
            </div>

        <h2>Batch test</h2>
        <div class="inputs" >
            <input id="against" type="text" placeholder="Att" class="score" >
            <input id="interval" type="number" placeholder="Interval" class="score" max="100" min="0">
            <input id="value" type="number" placeholder="Value" class="score" max="100" min="0">
            <label for="downloadCSV">Download CSV?</label>
            <input name="downloadCSV" id="downloadCSV" type="checkbox" checked='true' class="score">
        </div>
        <button onclick="batchTest(document.getElementById('against').value,parseInt(document.getElementById('interval').value),parseInt(document.getElementById('value').value),document.getElementById('downloadCSV').checked)" class="estimate">Batch Run</button>
    </div>


    <script>





// create a simple feed forward neural network with backpropagation


//const output = net.run([1, 1,1,1,1]);  // [0.987]


function log(txt, success){
    var type;
    if (success) {
        type = "[ok]"
    } else {
        type = "[!]"
    }
    var logBox = document.getElementById('log');
    logBox.innerText += " \n " + type + " " + txt;
    logBox.scrollTop = logBox.scrollHeight - logBox.clientHeight;
}
//


log('Preparing Dataset....');
var trainingData = [];
dataset.forEach(function(e){
	trainingData.push({input:[e.Attendance, e.PL, e.PR,e.PS,e.PW],output:[e.Final]})
})
log('Dataset Ready....', true);
log('Preparing Config....');

        // provide optional config object (or undefined). Defaults shown.
        const config = {
    binaryThresh: 0.5,
    hiddenLayers: [3],     // array of ints for the sizes of the hidden layers in the network
    activation: 'sigmoid',  // supported activation types: ['sigmoid', 'relu', 'leaky-relu', 'tanh'],
    leakyReluAlpha: 0.01   // supported for activation type 'leaky-relu'
};
log('Config Ready....', true);
log('Preparing Neural Network....');
const net = new brain.NeuralNetwork(config);
log('Neural Network Ready....');

log('Training Neural Network....');
var training = net.train(trainingData);
log('Training error: ' + training.error);
log('Trained and Ready...', true);
var result;
function estimate(){
    log('Calculating...');
   result = net.run([document.getElementById('Att').value/100,document.getElementById('PL').value/100,document.getElementById('PR').value/100,document.getElementById('PS').value/100,document.getElementById('PW').value/100]);
    document.getElementById("result").innerHTML = result[0]*100;
    log('Calculated value: ' + result, true);
    log('Ready for another calculation...', true);
}

function batchTest(against, interval, value, downloadCSV){
    var result = [];
    var testCase;
    for (let i = 0; i <= 100; i = i + interval) {
        switch (against) {
            case 'Att':
                    testCase = [i/100, value/100,value/100,value/100,value/100];
                break;
            case 'PR':
                    testCase = [value/100,value/100,i/100,value/100,value/100];
                break;
            case 'PW':
                    testCase = [value/100,value/100,value/100,value/100,i/100];
                break;
            case 'PL':
                    testCase = [value/100,i/100,value/100,value/100,value/100];
                break;
            case 'PS':
                    testCase = [value/100,value/100,value/100,i/100,value/100];
                break;
            default:
                console.log("use one of the following against [Att, PR, PW, PL, or PS].");
                break;
        }
        result.push({
            value: i,
            estimate: net.run(testCase)[0]
        });
    }
    if(downloadCSV){
        ConvertToCSV(result, against+'-'+interval+'-'+value+'.csv');
    }
    return result
}

function ConvertToCSV(objArray, filename) {
            var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
            var str = '';

            for (var i = 0; i < array.length; i++) {
                var line = '';
                for (var index in array[i]) {
                    if (line != '') line += ','

                    line += array[i][index];
                }

                str += line + '\r\n';
            }
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(str));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
}


    </script>
</body>
</html>

